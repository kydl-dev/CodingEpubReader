<UserControl
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d"
    x:Class="DesktopUI.Views.BookLibraryView"
    x:DataType="vm:BookLibraryViewModel"
    xmlns="https://github.com/avaloniaui"
    xmlns:awv="clr-namespace:AvaloniaWebView;assembly=Avalonia.WebView"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:DesktopUI.ViewModels"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">

    <Design.DataContext>
        <vm:BookLibraryViewModel />
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*,Auto">
        <!--  Header  -->
        <StackPanel Grid.Row="0" Margin="20,10">
            <TextBlock
                FontSize="24"
                FontWeight="Bold"
                Text="{Binding LibraryName}" />
            <TextBlock
                FontSize="14"
                Foreground="{DynamicResource AppTextMutedBrush}"
                IsVisible="{Binding LibraryDescription, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Margin="0,5,0,0"
                Text="{Binding LibraryDescription}"
                TextWrapping="Wrap" />
            <StackPanel
                Margin="0,10,0,0"
                Orientation="Horizontal"
                Spacing="20">
                <TextBlock FontSize="12" Foreground="{DynamicResource AppTextLowBrush}">
                    <Run Text="Total Books: " />
                    <Run FontWeight="Bold" Text="{Binding TotalBooks}" />
                </TextBlock>
                <TextBlock
                    FontSize="12"
                    Foreground="{DynamicResource AppTextLowBrush}"
                    IsVisible="{Binding LibraryLastUpdatedAt, Converter={x:Static ObjectConverters.IsNotNull}}">
                    <Run Text="Last Updated: " />
                    <Run Text="{Binding LibraryLastUpdatedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" />
                </TextBlock>
            </StackPanel>
            <StackPanel
                Margin="0,10,0,0"
                Orientation="Horizontal"
                Spacing="10">
                <Button Command="{Binding LoadBooksCommand}" Content="Refresh" />
                <Button Command="{Binding RefreshLibraryCommand}" Content="Scan Folders" />
            </StackPanel>
        </StackPanel>

        <!--  Book List  -->
        <ScrollViewer
            Grid.Row="1"
            HorizontalScrollBarVisibility="Disabled"
            IsVisible="{Binding IsLibraryMode}"
            VerticalScrollBarVisibility="Visible">
            <ItemsControl ItemsSource="{Binding Books}" Margin="20">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Background="{DynamicResource AppCardBackgroundBrush}"
                            BorderBrush="{DynamicResource AppCardBorderBrush}"
                            BorderThickness="1.5"
                            CornerRadius="10"
                            Margin="0,0,0,10"
                            Padding="15">
                            <Grid ColumnDefinitions="72,*,Auto" RowDefinitions="Auto,Auto,Auto,Auto,Auto">
                                <Border
                                    Background="{DynamicResource AppSurfaceAltBrush}"
                                    BorderBrush="{DynamicResource AppBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="6"
                                    Grid.Column="0"
                                    Grid.Row="0"
                                    Grid.RowSpan="5"
                                    Height="96"
                                    Width="64">
                                    <Grid>
                                        <TextBlock
                                            FontSize="10"
                                            Foreground="{DynamicResource AppTextLowBrush}"
                                            HorizontalAlignment="Center"
                                            Text="No Cover"
                                            VerticalAlignment="Center" />
                                        <Image
                                            IsVisible="{Binding CoverPreviewImage, Converter={x:Static ObjectConverters.IsNotNull}}"
                                            Source="{Binding CoverPreviewImage}"
                                            Stretch="UniformToFill" />
                                    </Grid>
                                </Border>

                                <!--  Title  -->
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Grid.Column="1"
                                    Grid.Row="0"
                                    Margin="12,0,0,0"
                                    Text="{Binding Title}"
                                    TextWrapping="Wrap" />

                                <!--  Primary Author  -->
                                <TextBlock
                                    FontSize="14"
                                    Foreground="{DynamicResource AppTextMutedBrush}"
                                    Grid.Column="1"
                                    Grid.Row="1"
                                    Margin="12,5,0,0"
                                    Text="{Binding PrimaryAuthor}" />

                                <!--  Language  -->
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource AppTextLowBrush}"
                                    Grid.Column="1"
                                    Grid.Row="2"
                                    Margin="12,5,0,0">
                                    <Run Text="Language: " />
                                    <Run Text="{Binding Language}" />
                                </TextBlock>

                                <!--  Added Date  -->
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource AppTextLowBrush}"
                                    Grid.Column="1"
                                    Grid.Row="3"
                                    Margin="12,5,0,0">
                                    <Run Text="Added: " />
                                    <Run Text="{Binding AddedDate, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" />
                                </TextBlock>

                                <!--  Last Opened Date  -->
                                <TextBlock
                                    FontSize="12"
                                    Foreground="{DynamicResource AppTextLowBrush}"
                                    Grid.Column="1"
                                    Grid.Row="4"
                                    IsVisible="{Binding LastOpenedDate, Converter={x:Static ObjectConverters.IsNotNull}}"
                                    Margin="12,5,0,0">
                                    <Run Text="Last opened: " />
                                    <Run Text="{Binding LastOpenedDate, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" />
                                </TextBlock>

                                <!--  Open Button + Progress  -->
                                <StackPanel
                                    Grid.Column="2"
                                    Grid.Row="0"
                                    Grid.RowSpan="5"
                                    Margin="10,0,0,0"
                                    Spacing="6"
                                    VerticalAlignment="Center">
                                    <Button
                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).OpenBookCommand}"
                                        CommandParameter="{Binding}"
                                        Content="Open Book"
                                        Padding="15,10" />
                                    <Button
                                        Command="{Binding $parent[UserControl].((vm:BookLibraryViewModel)DataContext).ShowBookDetailsCommand}"
                                        CommandParameter="{Binding}"
                                        Content="Details"
                                        Padding="15,8" />
                                    <Button
                                        Command="{Binding $parent[UserControl].((vm:BookLibraryViewModel)DataContext).PromptDeleteBookCommand}"
                                        CommandParameter="{Binding}"
                                        Content="Delete"
                                        Padding="15,8" />
                                    <TextBlock
                                        FontSize="11"
                                        Foreground="{DynamicResource AppTextMutedBrush}"
                                        HorizontalAlignment="Center"
                                        IsVisible="{Binding OverallProgress, Converter={x:Static ObjectConverters.IsNotNull}}"
                                        Text="{Binding OverallProgress, StringFormat='{}{0:P0}'}" />
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <ScrollViewer
            Grid.Row="1"
            IsVisible="{Binding IsRecentlyReadMode}"
            Margin="20,10,20,10">
            <StackPanel Spacing="8">
                <TextBlock
                    FontSize="20"
                    FontWeight="Bold"
                    Text="Recently Read" />
                <ItemsControl ItemsSource="{Binding RecentlyRead}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Background="{DynamicResource AppCardBackgroundBrush}"
                                BorderBrush="{DynamicResource AppCardBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Margin="0,0,0,8"
                                Padding="10">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel Grid.Column="0">
                                        <TextBlock
                                            FontSize="14"
                                            FontWeight="Bold"
                                            Text="{Binding Title}" />
                                        <TextBlock
                                            FontSize="12"
                                            Foreground="{DynamicResource AppTextMutedBrush}"
                                            Text="{Binding Author}" />
                                        <TextBlock FontSize="11" Foreground="{DynamicResource AppTextLowBrush}">
                                            <Run Text="Last Read: " />
                                            <Run Text="{Binding LastReadAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}" />
                                            <Run Text=" | Sessions: " />
                                            <Run Text="{Binding TotalSessions}" />
                                            <Run Text=" | Time: " />
                                            <Run Text="{Binding TotalReadingTime}" />
                                        </TextBlock>
                                    </StackPanel>
                                    <Button
                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).OpenBookByIdCommand}"
                                        CommandParameter="{Binding BookId}"
                                        Content="Open"
                                        Grid.Column="1"
                                        IsEnabled="{Binding CanOpen}"
                                        Margin="8,0,0,0"
                                        VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!--  Status Bar  -->
        <Border
            Background="{DynamicResource AppSurfaceBrush}"
            BorderBrush="{DynamicResource AppBorderBrush}"
            BorderThickness="0,1,0,0"
            Grid.Row="2"
            Padding="10">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock
                    FontSize="12"
                    Grid.Column="0"
                    Text="{Binding StatusMessage}"
                    VerticalAlignment="Center" />
                <TextBlock
                    FontSize="12"
                    Foreground="{DynamicResource AppTextMutedBrush}"
                    Grid.Column="1"
                    IsVisible="{Binding IsLoading}"
                    Text="Loading..."
                    VerticalAlignment="Center" />
            </Grid>
        </Border>

        <Border
            Background="#80000000"
            Grid.RowSpan="3"
            IsVisible="{Binding IsBookDetailsVisible}">
            <Grid>
                <Border
                    Background="{DynamicResource AppSurfaceBrush}"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="10"
                    HorizontalAlignment="Center"
                    MaxHeight="520"
                    Padding="16"
                    VerticalAlignment="Center"
                    Width="680">
                    <Grid RowDefinitions="Auto,*,Auto">
                        <Grid ColumnDefinitions="*,Auto" Grid.Row="0">
                            <TextBlock
                                FontSize="20"
                                FontWeight="Bold"
                                Text="{Binding SelectedBookDetails.Title}" />
                            <Button
                                Command="{Binding CloseBookDetailsCommand}"
                                Content="Close"
                                Grid.Column="1" />
                        </Grid>

                        <ScrollViewer Grid.Row="1" Margin="0,12,0,0">
                            <StackPanel Spacing="8">
                                <TextBlock Text="{Binding SelectedBookDetails.Authors, StringFormat='Authors: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.Language, StringFormat='Language: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.Publisher, StringFormat='Publisher: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.Isbn, StringFormat='ISBN: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.PublishedDate, StringFormat='Published: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.Subject, StringFormat='Subject: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.Rights, StringFormat='Rights: {0}'}" />
                                <TextBlock Text="{Binding SelectedBookDetails.EpubVersion, StringFormat='EPUB Version: {0}'}" />
                                <TextBlock
                                    FontSize="13"
                                    FontWeight="Bold"
                                    Margin="0,6,0,0"
                                    Text="Description" />
                                <Border
                                    BorderBrush="{DynamicResource AppBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="6"
                                    Height="200"
                                    Padding="2">
                                    <awv:WebView x:Name="DetailsDescriptionWebView" />
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <StackPanel
                            Grid.Row="2"
                            HorizontalAlignment="Right"
                            Margin="0,12,0,0"
                            Orientation="Horizontal">
                            <Button Command="{Binding CloseBookDetailsCommand}" Content="Close" />
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <Border
            Background="#80000000"
            Grid.RowSpan="3"
            IsVisible="{Binding IsDeleteConfirmVisible}">
            <Grid>
                <Border
                    Background="{DynamicResource AppSurfaceBrush}"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="10"
                    HorizontalAlignment="Center"
                    Padding="16"
                    VerticalAlignment="Center"
                    Width="460">
                    <StackPanel Spacing="12">
                        <TextBlock
                            FontSize="18"
                            FontWeight="Bold"
                            Text="Delete Book?" />
                        <TextBlock TextWrapping="Wrap">
                            <Run Text="This will remove " />
                            <Run FontWeight="Bold" Text="{Binding PendingDeleteBook.Title}" />
                            <Run Text=" from your library, including bookmarks, highlights, and reading progress." />
                        </TextBlock>
                        <TextBlock
                            Foreground="{DynamicResource AppTextMutedBrush}"
                            Text="Reading history snapshots are preserved."
                            TextWrapping="Wrap" />
                        <StackPanel
                            HorizontalAlignment="Right"
                            Orientation="Horizontal"
                            Spacing="8">
                            <Button Command="{Binding CancelDeleteBookCommand}" Content="Cancel" />
                            <Button
                                Classes="danger"
                                Command="{Binding ConfirmDeleteBookCommand}"
                                Content="Delete" />
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</UserControl>